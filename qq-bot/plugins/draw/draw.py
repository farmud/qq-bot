import random
from datetime import datetime

class TarotReading:
    def __init__(self):
        # 塔罗牌数据库
        # 大阿尔卡纳牌（22张）
        self.major_arcana = {
            "愚者": {
                "正位": "新的开始、冒险、自由奔放、纯真",
                "逆位": "鲁莽、不负责任、过于天真、危险的选择"
            },
            "魔术师": {
                "正位": "创造力、技能、意志力、主动性",
                "逆位": "技能不足、创意受阻、优柔寡断、欺骗"
            },
            "女祭司": {
                "正位": "直觉、智慧、神秘、内在知识",
                "逆位": "情绪不稳、隐藏的敌人、表里不一、直觉失准"
            },
            "女皇": {
                "正位": "丰收、母性、富足、创造力",
                "逆位": "空虚、依赖、过度保护、创造力不足"
            },
            "皇帝": {
                "正位": "权威、理性、领导力、父性",
                "逆位": "专制、固执、缺乏同情心、控制欲过强"
            },
            "教皇": {
                "正位": "信仰、教导、建议、传统",
                "逆位": "叛逆、不信任、教条、虚伪"
            },
            "恋人": {
                "正位": "爱情、和谐、关系、选择",
                "逆位": "分离、失衡、犹豫不决、不当选择"
            },
            "战车": {
                "正位": "胜利、意志力、自信、进取",
                "逆位": "失败、自大、固执、失控"
            },
            "力量": {
                "正位": "勇气、力量、说服力、自信",
                "逆位": "软弱、自卑、缺乏信心、滥用力量"
            },
            "隐士": {
                "正位": "智慧、洞察、独处、内省",
                "逆位": "孤独、偏执、封闭、迷失方向"
            },
            "命运之轮": {
                "正位": "转机、机会、命运、变化",
                "逆位": "厄运、阻碍、停滞、意外"
            },
            "正义": {
                "正位": "公平、正义、诚实、因果",
                "逆位": "不公、偏见、失衡、虚假"
            },
            "倒吊人": {
                "正位": "牺牲、等待、新视角、智慧",
                "逆位": "无谓牺牲、拖延、固执、自私"
            },
            "死神": {
                "正位": "结束、转变、蜕变、新生",
                "逆位": "停滞、抗拒改变、惧怕、衰败"
            },
            "节制": {
                "正位": "平衡、节制、调和、耐心",
                "逆位": "失衡、过度、冲突、浪费"
            },
            "恶魔": {
                "正位": "束缚、欲望、执着、物质主义",
                "逆位": "释放、觉醒、摆脱束缚、克制"
            },
            "塔": {
                "正位": "突变、崩塌、意外、启示",
                "逆位": "避免灾难、循序渐进、阻止改变"
            },
            "星星": {
                "正位": "希望、信心、启发、治愈",
                "逆位": "失望、悲观、迷失方向、缺乏信心"
            },
            "月亮": {
                "正位": "直觉、梦境、幻想、潜意识",
                "逆位": "混乱、恐惧、欺骗、误解"
            },
            "太阳": {
                "正位": "快乐、活力、成功、真理",
                "逆位": "压抑、失败、消沉、虚假的快乐"
            },
            "审判": {
                "正位": "复活、更新、觉醒、宽恕",
                "逆位": "拒绝、怀疑、自责、后悔"
            },
            "世界": {
                "正位": "完成、圆满、成功、统合",
                "逆位": "未完成、停滞、失败、缺乏成就"
            }
        }
        
        # 小阿尔卡纳牌（56张）
        self.minor_arcana = {
            # 权杖牌组
            "权杖王": {
                "正位": "有魄力、创意、领导力、冒险精神",
                "逆位": "专制、暴躁、鲁莽、独断专行"
            },
            "权杖皇后": {
                "正位": "热情、魅力、自信、独立",
                "逆位": "善妒、专制、反复无常、脾气暴躁"
            },
            "权杖骑士": {
                "正位": "冒险、行动、热情、出发",
                "逆位": "鲁莽、急躁、延迟、脾气暴躁"
            },
            "权杖侍从": {
                "正位": "新消息、探索、学习、热情",
                "逆位": "坏消息、延迟、不成熟、轻率"
            },
            "权杖十": {
                "正位": "负担、责任、压力、完成",
                "逆位": "负担过重、逃避责任、精疲力竭"
            },
            "权杖九": {
                "正位": "力量、防卫、准备、坚持",
                "逆位": "虚弱、失去立场、障碍、防卫过度"
            },
            "权杖八": {
                "正位": "行动、速度、改变、进展",
                "逆位": "延迟、阻碍、内部冲突、犹豫"
            },
            "权杖七": {
                "正位": "胜利、优势、竞争、挑战",
                "逆位": "失败、劣势、犹豫、内部纷争"
            },
            "权杖六": {
                "正位": "胜利、成功、好消息、表彰",
                "逆位": "延迟、骄傲、坏消息、失败"
            },
            "权杖五": {
                "正位": "竞争、冲突、挑战、运动",
                "逆位": "避免冲突、妥协、失去斗志"
            },
            "权杖四": {
                "正位": "稳定、和平、休息、庆祝",
                "逆位": "不安、混乱、缺乏休息、不稳定"
            },
            "权杖三": {
                "正位": "事业、扩张、合作、远见",
                "逆位": "延迟、阻碍、合作困难、短视"
            },
            "权杖二": {
                "正位": "计划、决定、平衡、选择",
                "逆位": "犹豫、拖延、优柔寡断、不平衡"
            },
            "权杖一": {
                "正位": "开始、创造、灵感、潜力",
                "逆位": "延迟、创意受阻、虚假的开始"
            },
            
            # 圣杯牌组
            "圣杯王": {
                "正位": "慈爱、艺术、同情心、智慧",
                "逆位": "情绪化、虚伪、操纵、缺乏同理心"
            },
            "圣杯皇后": {
                "正位": "关爱、滋养、直觉、同情",
                "逆位": "情绪不稳、依赖、缺乏同理心"
            },
            "圣杯骑士": {
                "正位": "浪漫、魅力、提议、邀请",
                "逆位": "欺骗、虚假、提议落空、失望"
            },
            "圣杯侍从": {
                "正位": "好消息、机会、学习、提议",
                "逆位": "坏消息、错失机会、不成熟"
            },
            "圣杯十": {
                "正位": "圆满、幸福、和谐、完美",
                "逆位": "破碎、不和、失去幸福、空虚"
            },
            "圣杯九": {
                "正位": "满足、幸福、愿望实现、享受",
                "逆位": "空虚、不满足、物质主义、贪婪"
            },
            "圣杯八": {
                "正位": "放弃、转变、寻找、前进",
                "逆位": "停滞、犹豫、拒绝改变、迷失"
            },
            "圣杯七": {
                "正位": "选择、幻想、评估、反省",
                "逆位": "迷惑、逃避现实、优柔寡断"
            },
            "圣杯六": {
                "正位": "回忆、相遇、礼物、怀旧",
                "逆位": "停滞过去、失去机会、离别"
            },
            "圣杯五": {
                "正位": "新希望、重获信心、重新开始",
                "逆位": "失望、悲伤、失去、后悔"
            },
            "圣杯四": {
                "正位": "新机会、觉醒、改变、行动",
                "逆位": "倦怠、停滞、无聊、不满"
            },
            "圣杯三": {
                "正位": "庆祝、欢乐、团体、友情",
                "逆位": "过度、放纵、疏离、孤独"
            },
            "圣杯二": {
                "正位": "合作、伙伴、爱情、结合",
                "逆位": "分离、不和、失衡、冲突"
            },
            "圣杯一": {
                "正位": "新的感情、创意、直觉、开始",
                "逆位": "情感受阻、创意不足、虚假的开始"
            },
            
            # 宝剑牌组
            "宝剑王": {
                "正位": "权威、理性、正直、真理",
                "逆位": "残酷、滥用权力、专制、不公"
            },
            "宝剑皇后": {
                "正位": "独立、智慧、洞察、直接",
                "逆位": "刻薄、冷酷、报复、欺骗"
            },
            "宝剑骑士": {
                "正位": "勇气、行动、智慧、正义",
                "逆位": "鲁莽、破坏、暴力、失败"
            },
            "宝剑侍从": {
                "正位": "新想法、求知、观察、准备",
                "逆位": "仓促、轻率、谎言、延迟"
            },
            "宝剑十": {
                "正位": "复原、希望、解脱、重生",
                "逆位": "结束、失败、痛苦、背叛"
            },
            "宝剑九": {
                "正位": "释放、觉醒、希望、康复",
                "逆位": "忧虑、焦躁、失眠、痛苦"
            },
            "宝剑八": {
                "正位": "释放、自由、突破、改变",
                "逆位": "束缚、限制、困境、无助"
            },
            "宝剑七": {
                "正位": "坦白、发现、醒悟、失败",
                "逆位": "欺骗、偷窃、策略、秘密"
            },
            "宝剑六": {
                "正位": "过渡、改变、旅行、和解",
                "逆位": "停滞、拖延、混乱、公开"
            },
            "宝剑五": {
                "正位": "和解、克服、胜利、复原",
                "逆位": "失败、冲突、竞争、挫折"
            },
            "宝剑四": {
                "正位": "休息、平静、疗养、沉思",
                "逆位": "焦虑、不安、行动、改变"
            },
            "宝剑三": {
                "正位": "恢复、宽恕、和解、治愈",
                "逆位": "心痛、悲伤、失去、背叛"
            },
            "宝剑二": {
                "正位": "选择、平衡、决定、和平",
                "逆位": "优柔寡断、失衡、紧张、欺骗"
            },
            "宝剑一": {
                "正位": "胜利、力量、清晰、真理",
                "逆位": "混乱、失败、滥用力量"
            },
            
            # 钱币牌组
            "钱币王": {
                "正位": "富有、实践、成功、可靠",
                "逆位": "贪婪、腐败、物质主义、失败"
            },
            "钱币皇后": {
                "正位": "富足、慷慨、安全、实用",
                "逆位": "贪婪、虚荣、不安全感"
            },
            "钱币骑士": {
                "正位": "勤奋、责任、效率、可靠",
                "逆位": "懒惰、固执、拖延、浪费"
            },
            "钱币侍从": {
                "正位": "机会、学习、好消息、实践",
                "逆位": "浪费、懒惰、坏消息、机会流失"
            },
            "钱币十": {
            "正位": "富裕、成功、圆满、安全",
            "逆位": "损失、破产、不安全、物质主义"
            },
            "钱币九": {
            "正位": "独立、富足、享受、成功",
            "逆位": "依赖、损失、虚荣、浪费"
            },
            "钱币八": {
            "正位": "技能、努力、进展、报酬",
            "逆位": "虚度光阴、缺乏技能、懒惰"
            },
            "钱币七": {
            "正位": "等待、评估、投资、规划",
            "逆位": "焦虑、损失、错误投资"
            },
            "钱币六": {
            "正位": "慷慨、分享、回报、平衡",
            "逆位": "自私、债务、失衡、贪婪"
            },
            "钱币五": {
            "正位": "改善、康复、帮助、希望",
            "逆位": "贫困、孤独、健康问题、担忧"
            },
            "钱币四": {
            "正位": "保守、安全、占有、控制",
            "逆位": "损失、不安全感、放手"
            },
            "钱币三": {
            "正位": "合作、技能、工作、团队",
            "逆位": "懒惰、低质量、团队失调"
            },
            "钱币二": {
            "正位": "平衡、适应、灵活、变化",
            "逆位": "失衡、混乱、优柔寡断"
            },
            "钱币一": {
            "正位": "机会、繁荣、物质、开始",
            "逆位": "错失机会、物质损失、延迟"
            }
        }
        # 合并大小阿尔卡纳
        self.tarot_cards = {**self.major_arcana, **self.minor_arcana}
    
    def draw_card(self, combined):
        # 随机抽取一张牌
        import hashlib
        card = random.choice(list(self.tarot_cards.keys()))
        # 随机决定正逆位
        # 计算 SHA-256 哈希值
        hash_object = hashlib.sha256(combined.encode())
        hash_hex = hash_object.hexdigest()
    
    # 将哈希值转换为整数，并取模 2 得到 0 或 1
        idx = int(hash_hex, 16) % 2
        position = '逆位' if idx == 0 else '正位'
        return card, position
    
    def daily_fortune(self, user_id):
        # 使用用户ID和当前日期作为随机种子，确保同一天抽到相同的牌
        today = datetime.now().strftime('%Y%m%d')
        combined = f"{user_id}{today}"
        random.seed(combined)
        
        card, position = self.draw_card(combined)
        meaning = self.tarot_cards[card][position]
        
        # 生成运势解读
        fortune_text = f"""今日塔罗牌解读：
    抽到的牌：{card}（{position}）
    牌意解析：{meaning}
    运势提示：
    {'正位牌显示今天运势不错，' if position == '正位' else '逆位牌提醒需要注意，'}
    {self._generate_advice(card, position)}
    """
        return fortune_text
    
    def _generate_advice(self, card, position):
        # 根据不同的牌生成建议
        if position == "正位":
            advice = {
 # 大阿尔卡纳
        "愚者": "今天适合尝试新事物，保持开放心态。",
        "魔术师": "今天很适合展现才能，把握机会。",
        "女祭司": "听从内心的声音做决定。",
        "女皇": "今天适合创造和享受生活。",
        "皇帝": "把握主动权，展现领导才能。",
        "教皇": "寻求智者建议，遵循传统智慧。",
        "恋人": "关注感情和人际关系，表达爱意。",
        "战车": "坚定前进，保持自信和决心。",
        "力量": "用温和的方式处理问题，保持耐心。",
        "隐士": "独处反思，寻找内在智慧。",
        "命运之轮": "把握机会，适应变化。",
        "正义": "做出公正决定，保持诚实。",
        "倒吊人": "换个角度思考，保持平和心态。",
        "死神": "接受改变，准备新的开始。",
        "节制": "保持平衡，循序渐进。",
        "恶魔": "正视欲望，适度放纵。",
        "塔": "准备接受改变，保持警觉。",
        "星星": "保持希望，相信直觉。",
        "月亮": "关注直觉，探索未知。",
        "太阳": "保持乐观，展现才能。",
        "审判": "接受新的召唤，重新开始。",
        "世界": "完成目标，庆祝成功。",

        # 权杖牌组
        "权杖王": "展现领导才能，大胆创新。",
        "权杖皇后": "保持热情，激发创造力。",
        "权杖骑士": "勇敢前进，把握机会。",
        "权杖侍从": "接受新消息，开始新计划。",
        "权杖十": "完成目标，承担责任。",
        "权杖九": "保持警惕，准备应对挑战。",
        "权杖八": "保持行动力，快速前进。",
        "权杖七": "坚持立场，保持竞争力。",
        "权杖六": "庆祝胜利，分享喜悦。",
        "权杖五": "接受挑战，保持竞争心。",
        "权杖四": "稳固基础，适度休息。",
        "权杖三": "扩展视野，寻求合作。",
        "权杖二": "做出选择，保持平衡。",
        "权杖一": "把握新机会，开始行动。",

        # 圣杯牌组
        "圣杯王": "展现同理心，关注情感。",
        "圣杯皇后": "表达关爱，滋养他人。",
        "圣杯骑士": "追求理想，表达感情。",
        "圣杯侍从": "接受好消息，保持开放。",
        "圣杯十": "享受幸福，分享快乐。",
        "圣杯九": "实现愿望，保持满足。",
        "圣杯八": "寻找新方向，改变现状。",
        "圣杯七": "明确选择，避免幻想。",
        "圣杯六": "怀念过去，重聚故人。",
        "圣杯五": "克服失望，重建希望。",
        "圣杯四": "自我反省，寻找方向。",
        "圣杯三": "庆祝欢聚，享受友情。",
        "圣杯二": "建立关系，保持和谐。",
        "圣杯一": "开启新感情，接受祝福。",

        # 宝剑牌组
        "宝剑王": "保持理性，明辨是非。",
        "宝剑皇后": "保持独立，表达真实。",
        "宝剑骑士": "勇往直前，坚持真理。",
        "宝剑侍从": "保持警觉，接收消息。",
        "宝剑十": "接受结束，准备重生。",
        "宝剑九": "面对恐惧，克服困扰。",
        "宝剑八": "打破束缚，寻求自由。",
        "宝剑七": "制定策略，谨慎行动。",
        "宝剑六": "克服困难，迎接改变。",
        "宝剑五": "面对挑战，解决冲突。",
        "宝剑四": "休息调养，恢复能量。",
        "宝剑三": "面对痛苦，寻求治愈。",
        "宝剑二": "权衡选择，保持平和。",
        "宝剑一": "把握真理，开创新局。",

        # 钱币牌组
        "钱币王": "稳健发展，务实前进。",
        "钱币皇后": "创造价值，享受成果。",
        "钱币骑士": "踏实工作，稳步前进。",
        "钱币侍从": "把握机会，学习成长。",
        "钱币十": "收获成功，享受富足。",
        "钱币九": "独立自主，稳固发展。",
        "钱币八": "专注技能，精进提升。",
        "钱币七": "耐心等待，持续投资。",
        "钱币六": "慷慨分享，互惠互利。",
        "钱币五": "克服困难，寻求帮助。",
        "钱币四": "稳固基础，保持节制。",
        "钱币三": "团队合作，共创价值。",
        "钱币二": "平衡收支，灵活调整。",
        "钱币一": "把握机遇，开创事业。"
            }
        else:
            advice = {
                 # 大阿尔卡纳
        "愚者": "行事需要多加考虑，不要过于冲动。",
        "魔术师": "暂时避免重要决定，多做准备。",
        "女祭司": "不要轻信他人，保持警惕。",
        "女皇": "避免过度消费，注意节制。",
        "皇帝": "适当放下固执，聆听他人建议。",
        "教皇": "避免过分教条，保持开放心态。",
        "恋人": "谨慎处理感情，避免冲动决定。",
        "战车": "控制好情绪，避免冲突。",
        "力量": "不要强求，适时示弱。",
        "隐士": "避免过度孤立，与人交流。",
        "命运之轮": "谨慎应对变化，做好准备。",
        "正义": "避免偏见，保持客观。",
        "倒吊人": "不要过分牺牲，照顾自己。",
        "死神": "不要抗拒改变，接受现实。",
        "节制": "避免极端，找回平衡。",
        "恶魔": "克制欲望，摆脱束缚。",
        "塔": "减少损失，谨慎行事。",
        "星星": "保持信心，克服失望。",
        "月亮": "提防欺骗，澄清误解。",
        "太阳": "暂时退让，等待时机。",
        "审判": "面对过去，接受教训。",
        "世界": "耐心等待，完善细节。",

        # 权杖牌组
        "权杖王": "控制脾气，避免专制。",
        "权杖皇后": "避免过度自信，保持谦逊。",
        "权杖骑士": "减少冲动，谨慎行事。",
        "权杖侍从": "等待时机，完善计划。",
        "权杖十": "适当放手，减轻负担。",
        "权杖九": "避免过度防备，保持开放。",
        "权杖八": "放慢节奏，调整方向。",
        "权杖七": "避免冲突，寻求合作。",
        "权杖六": "保持谦虚，避免骄傲。",
        "权杖五": "避免争斗，寻求和解。",
        "权杖四": "适时行动，避免安逸。",
        "权杖三": "调整计划，避免操之过急。",
        "权杖二": "果断决定，避免犹豫。",
        "权杖一": "完善准备，避免草率。",

        # 圣杯牌组
        "圣杯王": "控制情绪，避免多愁善感。",
        "圣杯皇后": "保持独立，避免过度依赖。",
        "圣杯骑士": "脚踏实地，避免幻想。",
        "圣杯侍从": "谨慎判断，避免轻信。",
        "圣杯十": "避免过度理想化，保持现实。",
        "圣杯九": "适度知足，避免贪婪。",
        "圣杯八": "明确方向，避免逃避。",
        "圣杯七": "面对现实，做出选择。",
        "圣杯六": "放下过去，向前看。",
        "圣杯五": "接受失败，重新开始。",
        "圣杯四": "采取行动，打破停滞。",
        "圣杯三": "避免过度放纵，保持节制。",
        "圣杯二": "正视问题，解决矛盾。",
        "圣杯一": "控制情感，保持理性。",

        # 宝剑牌组
        "宝剑王": "避免苛刻，保持宽容。",
        "宝剑皇后": "避免刻薄，保持善意。",
        "宝剑骑士": "减少攻击性，保持温和。",
        "宝剑侍从": "谨慎行事，避免轻率。",
        "宝剑十": "接受现实，准备重生。",
        "宝剑九": "面对问题，走出困扰。",
        "宝剑八": "寻求帮助，突破困境。",
        "宝剑七": "保持诚实，避免欺骗。",
        "宝剑六": "面对困难，寻求改变。",
        "宝剑五": "寻求和解，避免冲突。",
        "宝剑四": "适时行动，避免懈怠。",
        "宝剑三": "寻求帮助，接受安慰。",
        "宝剑二": "做出决定，避免犹豫。",
        "宝剑一": "谨慎行事，避免鲁莽。",

        # 钱币牌组
        "钱币王": "避免守旧，适当创新。",
        "钱币皇后": "避免铺张，适度节制。",
        "钱币骑士": "加快节奏，避免拖延。",
        "钱币侍从": "把握机会，避免错失。",
        "钱币十": "避免贪婪，知足常乐。",
        "钱币九": "寻求合作，避免孤立。",
        "钱币八": "调整方向，改变策略。",
        "钱币七": "及时行动，避免犹豫。",
        "钱币六": "量力而行，避免过度。",
        "钱币五": "寻求帮助，共度难关。",
        "钱币四": "适度开放，避免守财。",
        "钱币三": "独立思考，避免依赖。",
        "钱币二": "果断决策，避免摇摆。",
        "钱币一": "稳妥行事，避免冒进。"
            }
        return advice.get(card, "保持平和心态，相信自己。")

    # 使用示例
def handle_tarot_command(user_id):
    tarot = TarotReading()
    return tarot.daily_fortune(user_id)

# 测试代码
# if __name__ == "__main__":
#     result = handle_tarot_command("12345")
#     print(result)